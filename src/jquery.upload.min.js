!function(e){"function"==typeof define&&define.amd?define(["jquery"],e):e("undefined"!=typeof module&&module.exports?require("jquery"):jQuery)}(function(e){function t(t,i){i=e.extend({name:"",action:"",byIframe:!1,keepIframe:!1,withCredentials:!1,allowedQueue:!0,autoUpload:!0,uploadTrigger:null,triggerError:null,disabledClass:"disabled",dataType:"json",acceptType:null,acceptError:null,acceptMime:null,multiple:!1,maxFileSize:null,maxFileSizeError:null,add:null,dataFilter:null,done:null,error:null,progress:null},i),this.ele=e(t),this.options=i,this.supportXHR2="FormData"in window,this.isUseXHR=this.supportXHR2&&!i.byIframe,this.queue=[],this.createFileInput(),this.bindUploadTrigger()}var n={jpeg:"image/jpeg",jpg:"image/jpg",png:"image/png",gif:"image/gif",webp:"image/webp",txt:"text/plain",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",zip:"aplication/zip"};t.prototype={createFileInput:function(){var t=this.options,i="",o=this.ele,a=e('<input type="file" name="'+t.name+'" style="position:absolute;right:0;top:0;opacity:0;filter:alpha(opacity=0);width:auto!important;height:100%!important;padding:0!important;border:0!important;margin:0!important;cursor:pointer;font-size:216px!important;">');"static"===o.css("position")&&o.css("position","relative"),"hidden"!==o.css("overflow")&&o.css("overflow","hidden"),t.multiple&&a.attr("multiple","multiple"),t.acceptMime?a.attr("accept",t.acceptMime):t.acceptType&&(e.each(t.acceptType.split(","),function(e,t){i=i+","+(-1!==t.indexOf("/")?t:n[t]||"")}),""!==i&&(i=i.substring(1),a.attr("accept",i))),a.appendTo(o),this.fileInput=a,this.bindChange()},bindUploadTrigger:function(){var t=this,i=t.options;!1===i.autoUpload&&i.uploadTrigger&&e(i.uploadTrigger).addClass(i.disabledClass).on("click",function(){e(this).hasClass(i.disabledClass)?e.isFunction(i.triggerError)&&i.triggerError():t.submit()})},bindChange:function(){var t=this,i=t.options,n=i.acceptType;t.fileInput.on("change",function(){var o,a,r,s,l=e(this),p=l.val(),u=l[0].files,d=[];if(""!==p){if(n&&e.isFunction(i.acceptError)){for(a=new RegExp("\\.("+n.replace(/,/g,"|")+")$","i"),void 0===u&&(u=[{name:p}]),r=0,s=u.length;r<s;r++)o=u[r],a.test(o.name)||d.push(o.name);if(d.length)return i.acceptError(d.join(","),i),void l.val("")}if(i.maxFileSize&&void 0!==u&&e.isFunction(i.maxFileSizeError)){for(r=0,s=u.length;r<s;r++)(o=u[r]).size>1024*i.maxFileSize*1024&&d.push(o.name);if(d.length)return i.maxFileSizeError(d.join(","),i),void l.val("")}!1===i.autoUpload&&i.uploadTrigger&&e(i.uploadTrigger).removeClass(i.disabledClass),t.setQueueData(),i.autoUpload&&t.submit()}})},setQueueData:function(){var t,n,o,a=this.options,r=!0,s=this.fileInput,l=s.val(),p={ele:this.ele,options:a,filePath:l,fileName:this.getFileNameByPath(l),supportProgress:this.isUseXHR};if(this.isUseXHR){for(t=new FormData,n=s[0].files,i=0,len=n.length;i<len;i++)o=n[i],t.append(s.attr("name"),o);a.allowedQueue&&this.fileInput.val("")}else(t={form:e('<form method="post" enctype="multipart/form-data" style="position:absolute;left:-9999px;width:0;height:0;overflow:hidden;"></form>'),append:function(t,i){var n=this.form.find('[name="'+t+'"]');0===n.length?n=e('<input type="hidden" name="'+t+'" value="'+i+'">').appendTo(this.form):n.val(i)}}).form.append(s.off("change")),this.createFileInput();p.form=t,e.isFunction(a.add)&&!1===a.add(p)&&(r=!1),r&&(a.allowedQueue?this.queue.push(p):(this.queue=null,this.queue=[p]))},submit:function(){var e;!this.isUploading&&this.queue.length&&(this.isUploading=!0,e=this.queue[0],this.isUseXHR?this.uploadByXHR(e):this.uploadByForm(e))},nextQueue:function(){var t=this.options;this.queue.length&&this.queue.shift(),this.isUploading=!1,this.queue.length?this.submit():!1===t.autoUpload&&t.uploadTrigger&&e(t.uploadTrigger).addClass(t.disabledClass)},uploadByXHR:function(t){var i=this,n=i.options,o=new XMLHttpRequest;try{o.withCredentials=n.withCredentials}catch(e){}e.isFunction(n.progress)&&(o.upload.onprogress=function(e){e.lengthComputable&&(t.percent=Math.round(100*e.loaded/e.total),t.loaded=e.loaded,t.total=e.total,n.progress(t))}),o.onload=function(o){200===this.status||304===this.status?(t.response=this.responseText,e.isFunction(n.dataFilter)&&(t.response=n.dataFilter(t)),i.execResponse(t)):e.isFunction(n.error)&&n.error(t),i.nextQueue()},o.onerror=function(){i.nextQueue(),e.isFunction(n.error)&&n.error(t)},o.onabort=function(){i.nextQueue(),e.isFunction(n.abort)&&n.abort(t)},o.open("POST",n.action),o.send(t.form)},uploadByForm:function(t){var i,n=this,o=n.options,a=t.form.form;(i=n.checkIframe()).off("load").on("load",function(){try{t.response=i.contents().find("body").html(),e.isFunction(o.dataFilter)&&(t.response=i.contents().find("html").html(),t.response=o.dataFilter(t))}catch(e){}n.execResponse(t),o.keepIframe||(i.remove(),a.remove()),n.nextQueue()}),a.attr("action",o.action).attr("target",i.attr("name")).appendTo("body"),a.submit()},execResponse:function(t){var i=this.options,n=t.response;if("json"===i.dataType&&"string"==typeof n)try{n=e.parseJSON(n)}catch(e){n={}}n?(t.result=n,e.isFunction(i.done)&&i.done(t)):e.isFunction(i.error)&&i.error(t)},checkIframe:function(){var t="uploadIframe"+(new Date).getTime(),i=e('<iframe src="about:blank" name="'+t+'" style="display:none;"></iframe>');return i.appendTo("body"),i},getFileNameByPath:function(e){e=e.replace(/\//g,"\\");var t=/\\([^\\]+)$/.exec(e);return null!==t?t[1]:e}},e.upload=function(i,n){e(i).each(function(){var i=e(this);void 0===i.data("didBindUpload")&&(new t(e(this),n),i.data("didBindUpload",1))})},e.upload.setMIME=function(t){e.each(t,function(e,t){void 0===n[e]&&(n[e]=t)})}});